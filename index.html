<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Interval & Manpower Supply</title>

    <!-- SheetJS: read CSV/XLSX -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
    <!-- ExcelJS: write XLSX with styles -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>

    <style>
        :root{
            --bg: #f8fafc;
            --bg-2: #edf2f7;
            --text: #000000;
            --text-muted: #6b7280;
            --border: #d1d5db;
            --border-2: #e5e7eb;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --accent: #16a34a;
            --accent-2: #22c55e;
            --accent-dark: #15803d;
        }
        body {
            margin: 0;
            padding: 0 20px 20px 20px;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: url('Background1.png') no-repeat center center fixed;
            background-size: cover;
            color: var(--text);
            line-height: 1.6;
        }

        .nav-bar {
            background: linear-gradient(145deg, #ffffff 0%, var(--gray-100) 100%);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }

        .nav-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            background: linear-gradient(145deg, #f8fafc 0%, #e2e8f0 100%);
            color: #1e293b;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
            display: inline-block;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .nav-btn:hover {
            background: linear-gradient(145deg, #f1f5f9 0%, #cbd5e1 100%);
            border-color: #94a3b8;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .nav-btn.active {
            background: linear-gradient(145deg, #22c55e 0%, #16a34a 100%);
            border-color: #16a34a;
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        h2 {
            margin: 24px 0 16px;
            font-weight: 700;
            font-size: 1.5rem;
            letter-spacing: -0.025em;
            color: var(--text);
        }
        .page-header { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; width: 100%; margin: -10px 0 -39px; }
        .header-image { grid-column: 1; justify-self: start; max-height: 200px; width: auto; object-fit: contain; }
        .title-group { grid-column: 2; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .page-title { display: inline-flex; align-items: baseline; gap: 8px; font-weight: 900; font-size: 2rem; color: #000000; letter-spacing: -0.01em; margin: 0; }
        .page-title .accent { color: #16a34a; background: none; }
        .page-subtitle { font-size: 13px; color: #000000; opacity: 0.95; margin: 0; }
        .page-title .muted { color: #6b7280; }

        .card {
            background: linear-gradient(145deg, #ffffff 0%, var(--gray-50) 100%);
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 24px;
            margin-top: 20px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(6px);
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: end;
        }

        .row>* {
            flex: 1;
            min-width: 160px;
        }

        label {
            font-size: 13px;
            opacity: .9;
            margin-bottom: 6px;
            display: block;
            color: var(--text);
        }

        input[type=file],
        button {
            width: 100%;
            padding: 10px 20px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: #ffffff;
            color: var(--text);
            font-weight: 600;
            font-size: 15px;
            outline: none;
            transition: all 0.2s ease;
            height: 52px;
            box-sizing: border-box;
            line-height: 28px;
        }

        input[type=file]::file-selector-button {
            margin-right: 20px;
            border: none;
            background: linear-gradient(145deg, #22c55e 0%, #16a34a 100%);
            padding: 0 46px 40px 46px; /* Maximum upward push */
            height: 30px;
            line-height: 8px; /* Tight line height */
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-weight: 700;
            transition: background .2s;
            font-size: 13px;
            vertical-align: middle;
        }

        input[type=file]::file-selector-button:hover {
            background: linear-gradient(145deg, #16a34a 0%, #15803d 100%);
        }

        button {
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
            border-color: var(--gray-300);
            background: var(--gray-50);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        #genBtn {
            width: 100%;
        }

        .download-wrap {
            display: flex;
            justify-content: center;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #334155;
        }

        #downloadBtn {
            width: 240px;
            background: linear-gradient(145deg, #22c55e 0%, #16a34a 100%);
            border-color: #16a34a;
            color: #ffffff;
            font-weight: 700;
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3);
        }

        #downloadBtn:hover {
            background: linear-gradient(145deg, #16a34a 0%, #15803d 100%);
            box-shadow: 0 6px 24px rgba(34, 197, 94, 0.4);
        }

        /* ===========================
    DROPDOWN MULTI-SELECT
=========================== */
        .ms-dropdown {
            position: relative;
            width: 100%;
            z-index: 10000;
        }

        .ms-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: #ffffff;
            color: var(--text);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            font-size: 15px;
            height: 52px;
            box-sizing: border-box;
        }
       .logo-link {
            position: fixed;
            top: 10px;
            left: 10px;
            font-size: 22px;
            font-weight: bold;
            text-decoration: none;
            color: #000;
        }

        .logo-link:hover {
            opacity: 0.8;
        }
        

        .ms-btn:hover {
            border-color: var(--gray-300);
            background: var(--gray-50);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        .ms-btn .ms-label {
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 85%;
        }

        .ms-btn .ms-caret {
            opacity: .75;
            font-size: 14px;
            margin-left: 8px;
            color: var(--text-muted);
        }

        .ms-panel {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: #ffffff;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 16px;
            z-index: 9999;
            display: none;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.12);
            backdrop-filter: blur(8px);
        }

        .ms-panel.open {
            display: block;
        }

        .ms-search {
            width: 100%;
            padding: 14px 16px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: #ffffff;
            color: var(--text);
            font-weight: 500;
            margin-bottom: 12px;
            outline: none;
            transition: all 0.2s ease;
            font-size: 15px;
            box-sizing: border-box;
        }

        .ms-search:focus {
            border-color: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.15);
        }

        .ms-list {
            max-height: 250px;
            overflow: auto;
            padding-right: 6px;
        }

        .ms-list::-webkit-scrollbar {
            width: 6px;
        }

        .ms-list::-webkit-scrollbar-track {
            background: var(--gray-200);
            border-radius: 3px;
        }

        .ms-list::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 3px;
        }

        .ms-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
            margin-bottom: 2px;
        }

        .ms-item:hover {
            background: var(--gray-100);
        }

        .ms-item input {
            width: 18px;
            height: 18px;
            accent-color: #22c55e;
            cursor: pointer;
        }

        .ms-item span {
            font-size: 15px;
            color: var(--text);
            font-weight: 500;
        }

        /* ===========================
    TABLES
=========================== */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 13px;
            overflow: hidden;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            margin-top: 16px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }

        thead th {
            background: linear-gradient(145deg, var(--gray-100) 0%, var(--gray-200) 100%);
            color: var(--text);
            padding: 12px 8px;
            border-bottom: 2px solid var(--gray-300);
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        thead th:first-child {
            background: linear-gradient(145deg, var(--gray-200) 0%, var(--gray-300) 100%);
            color: var(--text);
        }

        tbody td,
        tbody th {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid var(--gray-200);
            border-right: 1px solid var(--gray-200);
            color: var(--text);
            font-weight: 600;
            background: #ffffff;
            transition: all 0.2s ease;
        }

        tbody tr:last-child td,
        tbody tr:last-child th {
            border-bottom: none;
        }

        tbody td:last-child,
        thead th:last-child {
            border-right: none;
        }

        tbody th {
            background: linear-gradient(145deg, var(--gray-100) 0%, var(--gray-200) 100%);
            color: var(--text);
            font-weight: 700;
            text-align: left;
            padding-left: 16px;
            position: sticky;
            left: 0;
            min-width: 100px;
        }

        tbody tr:hover td {
            background: rgba(255, 255, 255, 0.95);
        }

        .nodata {
            padding: 32px 16px;
            text-align: center;
            color: #64748b;
            font-style: italic;
            background: linear-gradient(145deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 8px;
            margin-top: 16px;
        }

        /* Function supply cards (mirrors Operations Dashboard styling) */
        .functions-display {
            margin-bottom: 12px;
        }

        .functions-display label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 12px;
            display: block;
        }

        .functions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(128px, 1fr));
            gap: 8px;
        }
        .function-card-wide {
            grid-column: span 2;
        }
        .hidden { display: none !important; }
        .brand { display: flex; align-items: center; gap: 10px; }
        .brand-title { display: inline-flex; align-items: baseline; gap: 8px; font-weight: 800; font-size: 20px; letter-spacing: 0.2px; color: var(--text); }
        .brand-title .accent { color: var(--accent); }
        .brand-title .rest { color: var(--text-muted); opacity: 0.95; }

        .function-card {
            background: #ffffff;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            padding: 8px;
            text-align: center;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }

        .function-card:hover {
            border-color: var(--gray-300);
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .function-label {
            white-space: nowrap;
            display: inline-block;
            padding: 4px 6px;
            border-radius: 9999px;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            font-size: 10px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .function-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text);
        }

        .function-value.empty {
            opacity: 0.5;
        }
        /* Upload input sizing */
        input[type=file] {
            padding: 14px 20px;
            font-size: 15px;
            height: 48px;
        }
        input[type=file]::file-selector-button {
            padding: 10px 14px;
            margin-right: 12px;
            border-radius: 10px;
            border: 2px solid #334155;
            background: linear-gradient(145deg, #22c55e 0%, #16a34a 100%);
            color: #ffffff;
            font-weight: 700;
            cursor: pointer;
        }
        input[type=file]::file-selector-button:hover {
            background: linear-gradient(145deg, #16a34a 0%, #15803d 100%);
            border-color: #16a34a;
        }
        /* Dropdown search sizing */
        .ms-search {
            padding: 14px 16px;
            font-size: 15px;
            border-radius: 10px;
        }
        .ms-search:focus {
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
        }

        /* Drawer Styles */
        .drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px);
            z-index: 20000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .drawer-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .drawer {
            position: fixed;
            top: 0; right: 0; bottom: 0;
            width: 470px;
            max-width: 90vw;
            background: #ffffff;
            z-index: 20001;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -8px 0 24px rgba(0,0,0,0.15);
        }
        .drawer.open {
            transform: translateX(0);
        }
        .drawer-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--gray-50);
        }
        .drawer-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text);
        }
        .close-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            color: var(--text-muted);
            transition: color 0.2s;
            width: auto;
            height: auto;
            box-shadow: none;
        }
        .close-btn:hover {
            color: var(--text);
            background: none;
            transform: none;
            box-shadow: none;
        }
        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 450px; /* Extra space for dropdowns and new sliders */
        }
        .filter-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--gray-200);
        }
        .filter-section:last-child {
            border-bottom: none;
        }
        .filter-section h3 {
            font-size: 0.95rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            margin: 0 0 16px 0;
            letter-spacing: 0.5px;
        }
        .drawer-footer {
            padding: 20px;
            border-top: 1px solid var(--gray-200);
            background: var(--gray-50);
        }
        .drawer .row {
            flex-direction: column;
            gap: 16px;
        }
        .drawer .row > * {
            width: 100%;
        }
        .filter-trigger-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: auto;
            padding: 10px 24px;
            background: linear-gradient(145deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 99px;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
            font-weight: 700;
            cursor: pointer;
        }
        .filter-trigger-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(34, 197, 94, 0.5);
            background: linear-gradient(145deg, #16a34a 0%, #15803d 100%);
        }
    </style>
</head>

<body>


    <div class="page-header">
        <img src="logo.png" alt="Logo" class="header-image">
        <div class="title-group">
            <h2 class="page-title"><span class="muted">Interval & </span><span class="accent">Manpower</span><span class="muted"> Supply</span></h2>
            <div class="page-subtitle">Upload data and generate flight intervals</div>
        </div>
    </div>

    <button id="openDrawerBtn" class="filter-trigger-btn">
        <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align: middle; margin-right: 8px;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
        </svg>
        Filters
    </button>

    <button id="loginStatusBtn" class="filter-trigger-btn" style="top: 80px; background: linear-gradient(145deg, #64748b 0%, #475569 100%); box-shadow: 0 4px 12px rgba(100, 116, 139, 0.4);">
        <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align: middle; margin-right: 8px;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
        </svg>
        Admin Login
    </button>

    <div class="card">
        <div class="row">
            <div>
                <label>Upload CSV / Excel</label>
                <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" />
            </div>
        </div>

        <div class="download-wrap">
            <button id="downloadBtn" disabled>Download Excel</button>
        </div>
    </div>

    <!-- INTERVAL TABLES SECTION -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>All Flights (A + D)</h2>
            <button id="toggleIntervalsBtn" class="nav-btn" style="width: auto; padding: 6px 16px; height: auto;">
                Show Arrivals/Departures
            </button>
        </div>
        <div id="tblAll"></div>
        <div id="miniAll"></div>
    </div>

    <div id="intervalDetails" style="display: none;">
        <div class="card">
            <h2>Arrivals (A)</h2>
            <div id="tblA"></div>
            <div id="miniA"></div>
        </div>

        <div class="card">
            <h2>Departures (D)</h2>
            <div id="tblD"></div>
            <div id="miniD"></div>
        </div>
    </div>

    <!-- SUPPLY FILTERS (Drawer) -->
    
    <!-- SUPPLY TOTALS SECTION -->
    <div class="card" style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Function Totals (All Shifts)</h2>
            <button id="toggleShiftsBtn" class="nav-btn" style="width: auto; padding: 6px 16px; height: auto;">
                Show Shift Breakdown
            </button>
        </div>
        <div class="functions-display">
            <div class="functions-grid" id="functionsTotalGrid">
                <div class="function-card">
                    <div class="function-label">TRC</div>
                    <div class="function-value empty" id="supplyTotalTRC">-</div>
                </div>
                <div class="function-card">
                    <div class="function-label">BAG REP</div>
                    <div class="function-value empty" id="supplyTotalBAGREP">-</div>
                </div>
                <div class="function-card">
                    <div class="function-label">TECH OP</div>
                    <div class="function-value empty" id="supplyTotalTECHOP">-</div>
                </div>
                <div class="function-card">
                    <div class="function-label">DRIVERS</div>
                    <div class="function-value empty" id="supplyTotalDRIVERS">-</div>
                </div>
                <div class="function-card">
                    <div class="function-label">BAG OP</div>
                    <div class="function-value empty" id="supplyTotalBAGOP">-</div>
                </div>
                <div class="function-card">
                    <div class="function-label">LOAD CONTROL</div>
                    <div class="function-value empty" id="supplyTotalLOADCONTROL">-</div>
                </div>
                <div class="function-card">
                    <div class="function-label">RAMP GW</div>
                    <div class="function-value empty" id="supplyTotalRAMPGW">-</div>
                </div>
                <div class="function-card">
                    <div class="function-label">BASEMENT GW</div>
                    <div class="function-value empty" id="supplyTotalBASEMENTGW">-</div>
                </div>
                <div class="function-card">
                    <div class="function-label">BOARDING</div>
                    <div class="function-value empty" id="supplyTotalBOARDING">-</div>
                </div>
                <div class="function-card">
                    <div class="function-label">SERVICE AGENT</div>
                    <div class="function-value empty" id="supplyTotalSERVICEAGENT">-</div>
                </div>
                <div class="function-card function-card-wide">
                    <div class="function-label">BOARDING + SERVICE AGENT</div>
                    <div class="function-value empty" id="supplyTotalBOARDINGSERVICE">-</div>
                </div>
            </div>
        </div>
    </div>

    <div id="shiftDetails" style="display: none;">
        <div class="card" style="margin-top: 12px;">
            <h2>Function Supply - Shift A</h2>
            <div class="functions-display">
                <div class="functions-grid" id="functionsShiftAGrid">
                    <div class="function-card">
                        <div class="function-label">TRC</div>
                        <div class="function-value" id="supplyTRC">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">BAG REP</div>
                        <div class="function-value empty" id="supplyBAGREP">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">TECH OP</div>
                        <div class="function-value empty" id="supplyTECHOP">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">DRIVERS</div>
                        <div class="function-value empty" id="supplyDRIVERS">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">BAG OP</div>
                        <div class="function-value empty" id="supplyBAGOP">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">LOAD CONTROL</div>
                        <div class="function-value empty" id="supplyLOADCONTROL">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">RAMP GW</div>
                        <div class="function-value empty" id="supplyRAMPGW">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">BASEMENT GW</div>
                        <div class="function-value empty" id="supplyBASEMENTGW">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">BOARDING</div>
                        <div class="function-value empty" id="supplyBOARDING">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">SERVICE AGENT</div>
                        <div class="function-value empty" id="supplySERVICEAGENT">-</div>
                    </div>
                    <div class="function-card function-card-wide">
                        <div class="function-label">BOARDING + SERVICE AGENT</div>
                        <div class="function-value empty" id="supplyBOARDINGSERVICE">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 12px;">
            <h2>Function Supply - Shift B</h2>
            <div class="functions-display">
                <div class="functions-grid" id="functionsShiftBGrid">
                    <div class="function-card">
                        <div class="function-label">TRC</div>
                        <div class="function-value" id="supplyTRC_B">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">BAG REP</div>
                        <div class="function-value empty" id="supplyBAGREP_B">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">TECH OP</div>
                        <div class="function-value empty" id="supplyTECHOP_B">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">DRIVERS</div>
                        <div class="function-value empty" id="supplyDRIVERS_B">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">BAG OP</div>
                        <div class="function-value empty" id="supplyBAGOP_B">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">LOAD CONTROL</div>
                        <div class="function-value empty" id="supplyLOADCONTROL_B">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">RAMP GW</div>
                        <div class="function-value empty" id="supplyRAMPGW_B">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">BASEMENT GW</div>
                        <div class="function-value empty" id="supplyBASEMENTGW_B">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">BOARDING</div>
                        <div class="function-value empty" id="supplyBOARDING_B">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">SERVICE AGENT</div>
                        <div class="function-value empty" id="supplySERVICEAGENT_B">-</div>
                    </div>
                    <div class="function-card function-card-wide">
                        <div class="function-label">BOARDING + SERVICE AGENT</div>
                        <div class="function-value empty" id="supplyBOARDINGSERVICE_B">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 12px;">
            <h2>Function Supply - Shift C</h2>
            <div class="functions-display">
                <div class="functions-grid" id="functionsShiftCGrid">
                    <div class="function-card">
                        <div class="function-label">TRC</div>
                        <div class="function-value" id="supplyTRC_C">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">BAG REP</div>
                        <div class="function-value empty" id="supplyBAGREP_C">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">TECH OP</div>
                        <div class="function-value empty" id="supplyTECHOP_C">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">DRIVERS</div>
                        <div class="function-value empty" id="supplyDRIVERS_C">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">BAG OP</div>
                        <div class="function-value empty" id="supplyBAGOP_C">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">LOAD CONTROL</div>
                        <div class="function-value empty" id="supplyLOADCONTROL_C">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">RAMP GW</div>
                        <div class="function-value empty" id="supplyRAMPGW_C">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">BASEMENT GW</div>
                        <div class="function-value empty" id="supplyBASEMENTGW_C">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">BOARDING</div>
                        <div class="function-value empty" id="supplyBOARDING_C">-</div>
                    </div>
                    <div class="function-card">
                        <div class="function-label">SERVICE AGENT</div>
                        <div class="function-value empty" id="supplySERVICEAGENT_C">-</div>
                    </div>
                    <div class="function-card function-card-wide">
                        <div class="function-label">BOARDING + SERVICE AGENT</div>
                        <div class="function-value empty" id="supplyBOARDINGSERVICE_C">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DRAWER HTML -->
    <div class="drawer-overlay" id="drawerOverlay"></div>
    <div class="drawer" id="filterDrawer">
        <div class="drawer-header">
            <div class="drawer-title">Filters</div>
            <button class="close-btn" id="closeDrawerBtn">
                <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="drawer-content">
            
            <div class="filter-section">
                <h3>Interval Generation</h3>
                <div class="row">
                    <div>
                        <label>Station</label>
                        <div id="stationDD" class="ms-dropdown"></div>
                    </div>
                    <div>
                        <label>Location</label>
                        <div id="locationDD" class="ms-dropdown"></div>
                    </div>
                    <div>
                        <label>Serviced By</label>
                        <div id="servicedDD" class="ms-dropdown"></div>
                    </div>
                    <div>
                        <label>Month </label>
                        <div id="monthDD" class="ms-dropdown"></div>
                    </div>
                    <div>
                        <label>Day</label>
                        <div id="dayDD" class="ms-dropdown"></div>
                    </div>
                    <div>
                        <label>Shift</label>
                        <div id="shiftDD" class="ms-dropdown"></div>
                    </div>
                    <div>
                        <label>Local Airlines</label>
                        <div id="airlineLocalDD" class="ms-dropdown"></div>
                    </div>
                    <div>
                        <label>Foreign Airlines</label>
                        <div id="airlineForeignDD" class="ms-dropdown"></div>
                    </div>
                    <div>
                        <label>Dedicated Teams</label>
                        <div id="airlineDedicatedDD" class="ms-dropdown"></div>
                    </div>
                    <button id="genBtn" disabled style="display: none;">Generate Tables</button>
                </div>
            </div>

            <div class="filter-section">
                <h3>Shift Configuration</h3>
                <div style="display:grid; grid-template-columns: 30px 1fr 1fr; gap:8px; align-items:center; font-size:12px; margin-bottom: 12px;">
                    <div style="font-weight:600;">A</div>
                    <input type="number" id="shiftA_start" placeholder="Start" min="0" max="23" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px;">
                    <input type="number" id="shiftA_end" placeholder="End" min="0" max="23" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px;">
                    
                    <div style="font-weight:600;">B</div>
                    <input type="number" id="shiftB_start" placeholder="Start" min="0" max="23" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px;">
                    <input type="number" id="shiftB_end" placeholder="End" min="0" max="23" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px;">
                    
                    <div style="font-weight:600;">C</div>
                    <input type="number" id="shiftC_start" placeholder="Start" min="0" max="23" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px;">
                    <input type="number" id="shiftC_end" placeholder="End" min="0" max="23" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px;">
                </div>
                <button id="updateShiftsBtn" class="nav-btn" style="width:100%; text-align:center; justify-content:center; padding:8px; margin-top:0;">Update Shift Hours</button>
            </div>

            <div class="filter-section">
                <h3>Engagement Rules</h3>
                <div class="row" style="flex-direction: column; align-items: stretch; gap: 12px;">
                    <div id="engagementRulesContainer" style="display: grid; grid-template-columns: 1fr 90px 90px 110px; gap: 8px; align-items: center;">
                        <div style="font-weight: 700; font-size: 12px;">Function</div>
                        <div style="font-weight: 700; font-size: 12px;">Count</div>
                        <div style="font-weight: 700; font-size: 12px;">Fraction</div>
                        <div style="font-weight: 700; font-size: 12px;">Flights</div>
                    </div>
                    <div style="margin-top: 8px;">
                        <input type="text" id="presetNameInput" placeholder="Preset Name (e.g., Weekend Shift)" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div style="margin-top: 8px; display: grid; grid-template-columns: 1.4fr 0.6fr 0.6fr 0.6fr; gap: 8px; align-items: center;">
                        <input type="text" id="newFunctionName" placeholder="New function name" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">
                        <input type="number" id="newFunctionCount" placeholder="Count" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">
                        <input type="number" id="newFunctionFraction" placeholder="Fraction" step="0.01" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">
                        <input type="number" id="newFunctionFlights" placeholder="Flights" min="1" step="1" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">
                    </div>
                    <div style="margin-top: 6px;">
                        <button id="addFunctionBtn" class="nav-btn" style="width: 100%; justify-content: center; padding: 6px 4px; font-size: 12px;">
                            Add Function
                        </button>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button id="resetEngagementBtn" class="nav-btn" style="flex: 1; text-align: center; justify-content: center; padding: 6px 4px;">
                            Reset
                        </button>
                        <button id="saveEngagementBtn" class="nav-btn" style="flex: 1; text-align: center; justify-content: center; padding: 6px 4px;">
                            Save
                        </button>
                        <button id="deleteEngagementBtn" class="nav-btn" style="flex: 1; text-align: center; justify-content: center; background: #fee2e2; color: #991b1b; display: none; padding: 6px 4px;">
                            Delete
                        </button>
                    </div>
                    <div id="engagementPresetBoxes" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;"></div>
                </div>
            </div>

        </div>
    </div>

    <script>
        /*******************************************************
          GLOBALS + HELPERS
        ********************************************************/
        let rows = [];
        let finalA = null;
        let finalD = null;
        let finalAll = null;

        let shiftDefinitions = {
            A: { start: 0, end: 7 },
            B: { start: 8, end: 15 },
            C: { start: 16, end: 23 }
        };
        try {
            const savedShifts = localStorage.getItem("shiftDefinitions");
            if (savedShifts) {
                shiftDefinitions = JSON.parse(savedShifts);
            }
        } catch(e) { console.warn("Could not load shifts", e); }

        function isHourInShift(h, start, end) {
            h = Number(h);
            start = Number(start);
            end = Number(end);
            if (start <= end) {
                return h >= start && h <= end;
            } else {
                // Crosses midnight
                return h >= start || h <= end;
            }
        }

        const HOURS = [...Array(24).keys()];
        const clean = x => (x ?? "").toString().trim();
        const upper = x => clean(x).toUpperCase();
        const HEAT = ["#d1fae5", "#86efac", "#4ade80", "#22c55e", "#15803d"];

        // Safe localStorage setter (survives quota / privacy blocks)
        function safeStore(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (err) {
                console.warn("Could not save to localStorage", err);
            }
        }

        function uniq(arr) { return [...new Set(arr.filter(v => v !== ""))].sort(); }

        /*******************************************************
          FUNCTION SUPPLY DISPLAY (cards at bottom, shifts A/B/C)
          - Uses counts from operations-db.json (field: count).
          - Formula: (shiftMax * count) * 1.58 per function per shift.
          - shiftMax comes from the All Flights table (hour row) per shift.
        ********************************************************/
        const functionSupplyEls = {
            A: {
                "TRC": document.getElementById("supplyTRC"),
                "BAG REP": document.getElementById("supplyBAGREP"),
                "TECH OP": document.getElementById("supplyTECHOP"),
                "DRIVERS": document.getElementById("supplyDRIVERS"),
                "BAG OP": document.getElementById("supplyBAGOP"),
                "LOAD CONTROL": document.getElementById("supplyLOADCONTROL"),
                "RAMP GW": document.getElementById("supplyRAMPGW"),
                "BASEMENT GW": document.getElementById("supplyBASEMENTGW"),
                "BOARDING": document.getElementById("supplyBOARDING"),
                "SERVICE AGENT": document.getElementById("supplySERVICEAGENT"),
                "BOARDING + SERVICE AGENT": document.getElementById("supplyBOARDINGSERVICE"),
            },
            B: {
                "TRC": document.getElementById("supplyTRC_B"),
                "BAG REP": document.getElementById("supplyBAGREP_B"),
                "TECH OP": document.getElementById("supplyTECHOP_B"),
                "DRIVERS": document.getElementById("supplyDRIVERS_B"),
                "BAG OP": document.getElementById("supplyBAGOP_B"),
                "LOAD CONTROL": document.getElementById("supplyLOADCONTROL_B"),
                "RAMP GW": document.getElementById("supplyRAMPGW_B"),
                "BASEMENT GW": document.getElementById("supplyBASEMENTGW_B"),
                "BOARDING": document.getElementById("supplyBOARDING_B"),
                "SERVICE AGENT": document.getElementById("supplySERVICEAGENT_B"),
                "BOARDING + SERVICE AGENT": document.getElementById("supplyBOARDINGSERVICE_B"),
            },
            C: {
                "TRC": document.getElementById("supplyTRC_C"),
                "BAG REP": document.getElementById("supplyBAGREP_C"),
                "TECH OP": document.getElementById("supplyTECHOP_C"),
                "DRIVERS": document.getElementById("supplyDRIVERS_C"),
                "BAG OP": document.getElementById("supplyBAGOP_C"),
                "LOAD CONTROL": document.getElementById("supplyLOADCONTROL_C"),
                "RAMP GW": document.getElementById("supplyRAMPGW_C"),
                "BASEMENT GW": document.getElementById("supplyBASEMENTGW_C"),
                "BOARDING": document.getElementById("supplyBOARDING_C"),
                "SERVICE AGENT": document.getElementById("supplySERVICEAGENT_C"),
                "BOARDING + SERVICE AGENT": document.getElementById("supplyBOARDINGSERVICE_C"),
            }
        };
        const functionTotalsEls = {
            "TRC": document.getElementById("supplyTotalTRC"),
            "BAG REP": document.getElementById("supplyTotalBAGREP"),
            "TECH OP": document.getElementById("supplyTotalTECHOP"),
            "DRIVERS": document.getElementById("supplyTotalDRIVERS"),
            "BAG OP": document.getElementById("supplyTotalBAGOP"),
            "LOAD CONTROL": document.getElementById("supplyTotalLOADCONTROL"),
            "RAMP GW": document.getElementById("supplyTotalRAMPGW"),
            "BASEMENT GW": document.getElementById("supplyTotalBASEMENTGW"),
            "BOARDING": document.getElementById("supplyTotalBOARDING"),
            "SERVICE AGENT": document.getElementById("supplyTotalSERVICEAGENT"),
            "BOARDING + SERVICE AGENT": document.getElementById("supplyTotalBOARDINGSERVICE"),
        };

        function ensureFunctionCards(funcName) {
            if (functionTotalsEls[funcName]) return;
            const totalGrid = document.getElementById("functionsTotalGrid");
            const gridA = document.getElementById("functionsShiftAGrid");
            const gridB = document.getElementById("functionsShiftBGrid");
            const gridC = document.getElementById("functionsShiftCGrid");
            if (!totalGrid || !gridA || !gridB || !gridC) return;

            function createCard(grid, labelText) {
                const card = document.createElement("div");
                card.className = "function-card";
                const label = document.createElement("div");
                label.className = "function-label";
                label.textContent = labelText;
                const value = document.createElement("div");
                value.className = "function-value empty";
                value.textContent = "-";
                card.appendChild(label);
                card.appendChild(value);
                grid.appendChild(card);
                return value;
            }

            const totalEl = createCard(totalGrid, funcName);
            functionTotalsEls[funcName] = totalEl;

            const gridsByShift = { A: gridA, B: gridB, C: gridC };
            Object.keys(gridsByShift).forEach(shiftKey => {
                const grid = gridsByShift[shiftKey];
                const valueEl = createCard(grid, funcName);
                if (!functionSupplyEls[shiftKey]) functionSupplyEls[shiftKey] = {};
                functionSupplyEls[shiftKey][funcName] = valueEl;
            });
        }

        let operationsDB = [];

        async function loadOperationsDB() {
            try {
                const resp = await fetch("operations-db.json");
                operationsDB = await resp.json();
            } catch (err) {
                console.warn("Could not load operations-db.json", err);
                operationsDB = [];
            }
        }

        function setFunctionSupply(shiftKey, name, value) {
            const el = functionSupplyEls[shiftKey]?.[name];
            if (!el) return;
            if (value === undefined || value === null || value === "") {
                el.textContent = "-";
                el.classList.add("empty");
            } else {
                el.textContent = value;
                el.classList.remove("empty");
            }
        }

        function resetFunctionSupplies() {
            Object.keys(functionSupplyEls).forEach(shiftKey => {
                Object.values(functionSupplyEls[shiftKey]).forEach(el => {
                    el.textContent = "-";
                    el.classList.add("empty");
                });
            });
            Object.values(functionTotalsEls).forEach(el => {
                if (!el) return;
                el.textContent = "-";
                el.classList.add("empty");
            });
        }

        function getFunctionCount(funcName) {
            if (!operationsDB || operationsDB.length === 0) return 1;
            const total = operationsDB
                .filter(op => op.function === funcName)
                .reduce((sum, op) => {
                    const c = Number(op.count);
                    return sum + (Number.isFinite(c) && c > 0 ? c : 0);
                }, 0);
            return total > 0 ? total : 1;
        }

        // Multiplier per function (customize per function if needed)
        const DEFAULT_MULTIPLIER = {
            "TRC": 1.48,
            "BAG REP": 1.48,
            "TECH OP": 1.48,
            "DRIVERS": 1.48,
            "BAG OP": 1.48,
            "LOAD CONTROL": 1.48,
            "RAMP GW": 1.17,
            "BASEMENT GW": 1.17,
            "BOARDING": 1.48,
            "SERVICE AGENT": 1.48,
            "BOARDING + SERVICE AGENT": 1.48,
        };
        const DEFAULT_COUNTS = {
            "TRC": 1,
            "BAG REP": 1,
            "TECH OP": 2,
            "DRIVERS": 2,
            "BAG OP": 1,
            "LOAD CONTROL": 1,
            "RAMP GW": 4,
            "BASEMENT GW": 2,
            "BOARDING": 1,
            "SERVICE AGENT": 3,
            "BOARDING + SERVICE AGENT": 4,
        };
        const DEFAULT_PASSENGERS = {
            "TRC": 1,
            "BAG REP": 1,
            "TECH OP": 1,
            "DRIVERS": 1,
            "BAG OP": 1,
            "LOAD CONTROL": 5,
            "RAMP GW": 1,
            "BASEMENT GW": 1,
            "BOARDING": 1,
            "SERVICE AGENT": 1,
            "BOARDING + SERVICE AGENT": 1,
        };
        const BASE_FUNCTION_KEYS = Object.keys(DEFAULT_COUNTS);

        function deleteCustomFunction(name) {
            if (BASE_FUNCTION_KEYS.includes(name)) return;

            delete DEFAULT_COUNTS[name];
            delete DEFAULT_MULTIPLIER[name];
            delete DEFAULT_PASSENGERS[name];

            delete activeCounts[name];
            delete activeMultipliers[name];
            delete activePassengers[name];

            ["A", "B", "C"].forEach(shiftKey => {
                const el = functionSupplyEls[shiftKey]?.[name];
                if (el) {
                    const card = el.closest(".function-card");
                    if (card && card.parentElement) {
                        card.parentElement.removeChild(card);
                    }
                    delete functionSupplyEls[shiftKey][name];
                }
            });

            const totalEl = functionTotalsEls[name];
            if (totalEl) {
                const card = totalEl.closest(".function-card");
                if (card && card.parentElement) {
                    card.parentElement.removeChild(card);
                }
                delete functionTotalsEls[name];
            }

            renderEngagementRules();
            updateFunctionSupplies();
        }
        
        let activeMultipliers = { ...DEFAULT_MULTIPLIER };
        let activeCounts = { ...DEFAULT_COUNTS };
        let activePassengers = { ...DEFAULT_PASSENGERS };
        let engagementCountPresets = [];
        let engagementMultiplierPresets = [];
        let engagementPassengerPresets = [];
        let engagementPresetNames = [];
        let activePresetIndex = null;

        function randomInRange(min, max) {
            return min + Math.random() * (max - min);
        }

        function randomIntNear(base) {
            const delta = Math.floor(Math.random() * 3) - 1;
            const v = base + delta;
            return v < 1 ? 1 : v;
        }

        function generateEngagementPresets() {
            engagementCountPresets = [];
            engagementMultiplierPresets = [];
            engagementPassengerPresets = [];
            engagementPresetNames = [];
            const keys = Object.keys(DEFAULT_COUNTS);
            // Generate 3 random presets
            for (let i = 0; i < 3; i++) {
                const counts = {};
                const mults = {};
                const paxs = {};
                keys.forEach(k => {
                    counts[k] = randomIntNear(DEFAULT_COUNTS[k]);
                    paxs[k] = DEFAULT_PASSENGERS[k] || 1;
                    if (DEFAULT_MULTIPLIER[k] >= 1.3) {
                        mults[k] = Number(randomInRange(1.47, 1.56).toFixed(2));
                    } else {
                        const base = DEFAULT_MULTIPLIER[k];
                        const m = randomInRange(base - 0.1, base + 0.1);
                        mults[k] = Number(m.toFixed(2));
                    }
                });
                engagementCountPresets.push(counts);
                engagementMultiplierPresets.push(mults);
                engagementPassengerPresets.push(paxs);
                engagementPresetNames.push("Preset " + (i + 1));
            }
            // Load saved presets
            try {
                const saved = localStorage.getItem("myCustomPresets");
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (Array.isArray(parsed)) {
                        parsed.forEach(p => {
                            engagementCountPresets.push(p.counts);
                            engagementMultiplierPresets.push(p.mults);
                            engagementPassengerPresets.push(p.paxs);
                            engagementPresetNames.push(p.name || "Custom Preset");
                        });
                    }
                }
            } catch (e) {
                console.warn("Error loading custom presets", e);
            }
        }

        function applyEngagementPreset(index) {
            const idx = Number(index);
            if (!Number.isFinite(idx)) return;
            if (!engagementCountPresets[idx] || !engagementMultiplierPresets[idx] || !engagementPassengerPresets[idx]) return;
            activePresetIndex = idx;
            activeCounts = { ...engagementCountPresets[idx] };
            activeMultipliers = { ...engagementMultiplierPresets[idx] };
            activePassengers = { ...engagementPassengerPresets[idx] };
            
            // Show/hide Delete button (only for custom presets, index >= 3)
            const delBtn = document.getElementById("deleteEngagementBtn");
            if (delBtn) {
                if (idx >= 3) {
                    delBtn.style.display = "flex";
                } else {
                    delBtn.style.display = "none";
                }
            }

            renderEngagementRules();
            updateFunctionSupplies();
            renderEngagementPresetBoxes();
        }

        function renderEngagementPresetBoxes() {
            const container = document.getElementById("engagementPresetBoxes");
            if (!container) return;
            container.innerHTML = "";
            for (let i = 0; i < engagementCountPresets.length; i++) {
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "nav-btn" + (i === activePresetIndex ? " active" : "");
                btn.textContent = engagementPresetNames[i] || ("Preset " + (i + 1));
                btn.style.flex = "1 0 30%";
                btn.style.fontSize = "12px";
                btn.style.padding = "6px 8px";
                btn.addEventListener("click", () => applyEngagementPreset(i));
                container.appendChild(btn);
            }
        }

        function renderEngagementRules() {
            const container = document.getElementById("engagementRulesContainer");
            container.innerHTML = `
                <div style="font-weight: 700; font-size: 12px;">Function</div>
                <div style="font-weight: 700; font-size: 12px;">Count</div>
                <div style="font-weight: 700; font-size: 12px;">Fraction</div>
                <div style="font-weight: 700; font-size: 12px;">Flights</div>
            `;
            container.style.gridTemplateColumns = "1fr 70px 70px 90px";
            container.style.gap = "8px";

            Object.keys(DEFAULT_COUNTS).forEach(key => {
                ensureFunctionCards(key);
                const label = document.createElement("div");
                label.textContent = key;
                label.style.fontSize = "12px";
                label.style.fontWeight = "600";
                label.style.position = "relative";
                if (!BASE_FUNCTION_KEYS.includes(key)) {
                    const delBtn = document.createElement("button");
                    delBtn.type = "button";
                    delBtn.textContent = "";
                    delBtn.style.position = "absolute";
                    delBtn.style.right = "2px";
                    delBtn.style.top = "50%";
                    delBtn.style.transform = "translateY(-50%)";
                    delBtn.style.border = "none";
                    delBtn.style.background = "transparent";
                    delBtn.style.color = "#ef4444";
                    delBtn.style.fontSize = "10px";
                    delBtn.style.cursor = "pointer";
                    delBtn.style.padding = "0 2px";
                    delBtn.style.opacity = "0";
                    delBtn.style.transition = "opacity 0.15s ease";
                    label.addEventListener("mouseenter", () => {
                        delBtn.style.opacity = "1";
                    });
                    label.addEventListener("mouseleave", () => {
                        delBtn.style.opacity = "0";
                    });
                    delBtn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        deleteCustomFunction(key);
                    });
                    label.appendChild(delBtn);
                }

                const countInput = document.createElement("input");
                countInput.type = "number";
                countInput.value = activeCounts[key];
                countInput.style.width = "100%";
                countInput.style.padding = "4px";
                countInput.style.borderRadius = "4px";
                countInput.style.border = "1px solid #ccc";
                countInput.onchange = (e) => {
                    activeCounts[key] = Number(e.target.value);
                    updateFunctionSupplies();
                };

                const multInput = document.createElement("input");
                multInput.type = "number";
                multInput.step = "0.01";
                multInput.value = activeMultipliers[key];
                multInput.style.width = "100%";
                multInput.style.padding = "4px";
                multInput.style.borderRadius = "4px";
                multInput.style.border = "1px solid #ccc";
                multInput.onchange = (e) => {
                    activeMultipliers[key] = Number(e.target.value);
                    updateFunctionSupplies();
                };

                const paxInput = document.createElement("input");
                paxInput.type = "number";
                paxInput.step = "1";
                paxInput.min = "1";
                paxInput.value = activePassengers[key] ?? 1;
                paxInput.style.width = "100%";
                paxInput.style.padding = "4px";
                paxInput.style.borderRadius = "4px";
                paxInput.style.border = "1px solid #ccc";
                paxInput.onchange = (e) => {
                    activePassengers[key] = Number(e.target.value);
                    updateFunctionSupplies();
                };

                container.appendChild(label);
                container.appendChild(countInput);
                container.appendChild(multInput);
                container.appendChild(paxInput);
            });

        }

        document.getElementById("resetEngagementBtn").addEventListener("click", () => {
            activeCounts = { ...DEFAULT_COUNTS };
            activeMultipliers = { ...DEFAULT_MULTIPLIER };
            activePassengers = { ...DEFAULT_PASSENGERS };
            activePresetIndex = null;
            document.getElementById("presetNameInput").value = "";
            renderEngagementRules();
            updateFunctionSupplies();
            renderEngagementPresetBoxes();
        });

        document.getElementById("saveEngagementBtn").addEventListener("click", () => {
            // Check Admin
            const role = localStorage.getItem('userRole');
            if (role !== 'admin') {
                alert("Only Admins can save new presets.");
                return;
            }

            const nameInput = document.getElementById("presetNameInput");
            const name = nameInput.value.trim();
            
            if (!name) {
                alert("Please enter a name for the preset.");
                return;
            }

            const newCounts = { ...activeCounts };
            const newMults = { ...activeMultipliers };
            const newPaxs = { ...activePassengers };
            
            engagementCountPresets.push(newCounts);
            engagementMultiplierPresets.push(newMults);
            engagementPassengerPresets.push(newPaxs);
            engagementPresetNames.push(name);
            
            // Save to localStorage
            try {
                const saved = localStorage.getItem("myCustomPresets");
                let parsed = [];
                if (saved) {
                    parsed = JSON.parse(saved);
                }
                if (!Array.isArray(parsed)) parsed = [];
                parsed.push({ name: name, counts: newCounts, mults: newMults, paxs: newPaxs });
                safeStore("myCustomPresets", parsed);
            } catch(e) {
                console.warn("Could not save preset", e);
            }
            
            renderEngagementPresetBoxes();
            // Select the new preset
            applyEngagementPreset(engagementCountPresets.length - 1);
            
            // Clear input
            nameInput.value = "";
        });

        document.getElementById("deleteEngagementBtn").addEventListener("click", () => {
            // Check Admin
            const role = localStorage.getItem('userRole');
            if (role !== 'admin') {
                alert("Only Admins can delete presets.");
                return;
            }

            if (activePresetIndex === null || activePresetIndex < 3) return;
            
            if (!confirm("Are you sure you want to delete this preset?")) return;

            // Remove from arrays
            engagementCountPresets.splice(activePresetIndex, 1);
            engagementMultiplierPresets.splice(activePresetIndex, 1);
            engagementPassengerPresets.splice(activePresetIndex, 1);
            engagementPresetNames.splice(activePresetIndex, 1);
            
            // Re-save custom presets to localStorage
            // The custom presets start at index 3.
            // After splicing, the remaining custom presets are from index 3 onwards.
            const customCounts = engagementCountPresets.slice(3);
            const customMults = engagementMultiplierPresets.slice(3);
            const customPaxs = engagementPassengerPresets.slice(3);
            
            // We need to reconstruct the objects with names (names are not in the separate arrays, but we can assume order)
            // Actually, we should store names in the separate arrays or a separate name array.
            // Let's reload from localStorage and delete by index to be safe, or introduce a name array.
            // Simplest fix: Just update localStorage with the new sliced arrays, assuming names are lost? No, we need names.
            
            // Better approach: Update the 'parsed' list directly
            try {
                const saved = localStorage.getItem("myCustomPresets");
                let parsed = [];
                if (saved) parsed = JSON.parse(saved);
                if (Array.isArray(parsed)) {
                    // The index in 'parsed' is (activePresetIndex - 3)
                    const removeIdx = activePresetIndex - 3;
                    if (removeIdx >= 0 && removeIdx < parsed.length) {
                        parsed.splice(removeIdx, 1);
                        safeStore("myCustomPresets", parsed);
                    }
                }
            } catch(e) {
                console.warn("Error updating custom presets", e);
            }

            renderEngagementPresetBoxes();
            activePresetIndex = null;
            document.getElementById("deleteEngagementBtn").style.display = "none";
            document.getElementById("resetEngagementBtn").click();
        });

        const addFunctionBtn = document.getElementById("addFunctionBtn");
        if (addFunctionBtn) {
            addFunctionBtn.addEventListener("click", () => {
                const role = localStorage.getItem('userRole');
                if (role !== 'admin') {
                    alert("Only Admins can add new functions.");
                    return;
                }

                const nameInput = document.getElementById("newFunctionName");
                const countInput = document.getElementById("newFunctionCount");
                const fractionInput = document.getElementById("newFunctionFraction");
                const flightsInput = document.getElementById("newFunctionFlights");

                const name = nameInput.value.trim();
                if (!name) {
                    alert("Please enter a function name.");
                    return;
                }

                const countVal = Number(countInput.value);
                const multVal = Number(fractionInput.value);
                const flightsVal = Number(flightsInput.value);

                const count = Number.isFinite(countVal) && countVal > 0 ? countVal : 1;
                const mult = Number.isFinite(multVal) && multVal > 0 ? multVal : 1.0;
                const flights = Number.isFinite(flightsVal) && flightsVal > 0 ? flightsVal : 1;

                DEFAULT_COUNTS[name] = count;
                DEFAULT_MULTIPLIER[name] = mult;
                DEFAULT_PASSENGERS[name] = flights;

                activeCounts[name] = count;
                activeMultipliers[name] = mult;
                activePassengers[name] = flights;

                ensureFunctionCards(name);

                nameInput.value = "";
                countInput.value = "";
                fractionInput.value = "";
                flightsInput.value = "";

                renderEngagementRules();
                updateFunctionSupplies();
                renderEngagementPresetBoxes();
            });
        }

        window.addEventListener("DOMContentLoaded", () => {
            generateEngagementPresets();
            renderEngagementRules();
            renderEngagementPresetBoxes();
        });


        function updateFunctionSupplies() {
            if (!finalAll) {
                resetFunctionSupplies();
                return;
            }

            const shiftMax = computeShiftMax(finalAll) || [0, 0, 0];
            const shifts = ["A", "B", "C"];

            const selForeign = (ddAirlineForeign.getSelected().length);
            const selDedicated = (ddAirlineDedicated.getSelected().length);
            const selLocal = (ddAirlineLocal.getSelected().length);
            const foreignOrDedicatedPresent = (selForeign > 0 || selDedicated > 0);

            const boardingCount = foreignOrDedicatedPresent ? 0 : 1;
            const serviceAgentCount = foreignOrDedicatedPresent ? 0 : 3;
            const combinedCount = foreignOrDedicatedPresent ? 4 : 0;

            function setSeparateVisibility(show) {
                [
                    "supplyBOARDING", "supplyBOARDING_B", "supplyBOARDING_C", "supplyTotalBOARDING",
                    "supplySERVICEAGENT", "supplySERVICEAGENT_B", "supplySERVICEAGENT_C", "supplyTotalSERVICEAGENT"
                ].forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const card = el.closest(".function-card");
                    if (!card) return;
                    card.style.display = show ? "" : "none";
                });
            }
            function setCombinedVisibility(show) {
                ["supplyBOARDINGSERVICE", "supplyBOARDINGSERVICE_B", "supplyBOARDINGSERVICE_C", "supplyTotalBOARDINGSERVICE"].forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const card = el.closest(".function-card");
                    if (!card) return;
                    card.style.display = show ? "" : "none";
                });
            }
            setSeparateVisibility(!foreignOrDedicatedPresent);
            setCombinedVisibility(foreignOrDedicatedPresent);

            const totalsRawByFunc = {};
            shifts.forEach((shiftKey, idx) => {
                const maxVal = Number(shiftMax[idx]) || 0;
                Object.keys(functionSupplyEls[shiftKey]).forEach(funcName => {
                    let count = Number(activeCounts[funcName]) || 1;
                    if (funcName === "BOARDING") count = boardingCount;
                    if (funcName === "SERVICE AGENT") count = serviceAgentCount;
                    if (funcName === "BOARDING + SERVICE AGENT") count = combinedCount;
                    
                    let perShift;
                    const mult = Number(activeMultipliers[funcName]) || 1.48;
                    const pax = Number(activePassengers[funcName]) || 5;

                    if (funcName === "LOAD CONTROL") {
                        perShift = Math.round((maxVal * count / pax));
                    } else {
                        perShift = Math.round(maxVal * count);
                    }

                    setFunctionSupply(shiftKey, funcName, Number.isFinite(perShift) ? perShift : "-");
                    if (!Number.isFinite(totalsRawByFunc[funcName])) totalsRawByFunc[funcName] = 0;
                    totalsRawByFunc[funcName] += Number.isFinite(perShift) ? perShift : 0;
                });
            });
            Object.keys(functionTotalsEls).forEach(funcName => {
                const el = functionTotalsEls[funcName];
                if (!el) return;
                const base = totalsRawByFunc[funcName];
                const mult = Number(activeMultipliers[funcName]) || 1.48;
                
                let totalVal = Math.round(base * mult);

                if (!Number.isFinite(totalVal) || totalVal <= 0) {
                    el.textContent = "-";
                    el.classList.add("empty");
                } else {
                    el.textContent = totalVal;
                    el.classList.remove("empty");
                }
            });
        }

        /*******************************************************
          MULTI-SELECT DROPDOWN (Search + Clear)
        ********************************************************/
        function createMultiDropdown(containerId, placeholder, onChange) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
    <button type="button" class="ms-btn">
      <span class="ms-label">${placeholder}</span>
      <span class="ms-caret"></span>
    </button>
    <div class="ms-panel">
      <input class="ms-search" placeholder="Search..." />
      <div class="ms-list"></div>
    </div>
  `;

            const btn = container.querySelector(".ms-btn");
            const label = container.querySelector(".ms-label");
            const panel = container.querySelector(".ms-panel");
            const search = container.querySelector(".ms-search");
            const list = container.querySelector(".ms-list");

            const state = { allItems: [], selected: new Set() };
            let overlay = null;

            // Clear button
            const clearBtn = document.createElement("div");
            clearBtn.textContent = "Clear";
            clearBtn.style.cssText = `
    font-size: 12px;
    color: #ff7070;
    cursor: pointer;
    font-weight: 700;
    text-align: right;
    margin-bottom: 6px;
  `;
            clearBtn.onclick = (e) => {
                e.stopPropagation();
                state.selected.clear();
                updateLabel();
                renderList();
                if (onChange) onChange();
            };
            panel.insertBefore(clearBtn, search);

            btn.addEventListener("click", (e) => {
                e.stopPropagation();
                closeAllDropdowns();
                panel.classList.toggle("open");
                search.value = "";
                renderList();
                search.focus();
                if (panel.classList.contains("open")) {
                    const rect = btn.getBoundingClientRect();
                    overlay = document.createElement("div");
                    overlay.style.position = "fixed";
                    overlay.style.top = "0";
                    overlay.style.left = "0";
                    overlay.style.right = "0";
                    overlay.style.bottom = "0";
                    overlay.style.background = "transparent";
                    overlay.style.zIndex = "100000";
                    overlay.addEventListener("click", () => {
                        api.close();
                    });
                    document.body.appendChild(overlay);
                    panel.style.position = "fixed";
                    panel.style.top = `${rect.bottom + 8}px`;
                    panel.style.left = `${rect.left}px`;
                    panel.style.width = `${rect.width}px`;
                    panel.style.zIndex = "100001";
                    document.body.appendChild(panel);
                }
            });

            search.addEventListener("input", renderList);
            panel.addEventListener("click", (e) => e.stopPropagation());

            function renderList() {
                const q = upper(search.value);
                const shown = state.allItems.filter(x => upper(x).includes(q));
                list.innerHTML = shown.map(item => {
                    const checked = state.selected.has(item) ? "checked" : "";
                    return `
        <label class="ms-item">
          <input type="checkbox" value="${item}" ${checked}/>
          <span>${item}</span>
        </label>
      `;
                }).join("");

                list.querySelectorAll("input[type=checkbox]").forEach(cb => {
                    cb.addEventListener("change", () => {
                        if (cb.checked) state.selected.add(cb.value);
                        else state.selected.delete(cb.value);
                        updateLabel();
                        if (onChange) onChange();
                    });
                });
            }

            function updateLabel() {
                const arr = [...state.selected];
                if (arr.length === 0) label.textContent = placeholder;
                else if (arr.length <= 2) label.textContent = arr.join(", ");
                else label.textContent = `${arr.length} selected`;
            }

            function setItems(items) {
                state.allItems = items;
                state.selected.clear();
                updateLabel();
            }

            function getSelected() { return [...state.selected]; }

            const api = {
                setItems,
                getSelected,
                close: () => {
                    panel.classList.remove("open");
                    if (overlay) {
                        try { document.body.removeChild(overlay); } catch {}
                        overlay = null;
                    }
                    if (panel && panel.parentElement === document.body) {
                        container.appendChild(panel);
                        panel.style.position = "";
                        panel.style.top = "";
                        panel.style.left = "";
                        panel.style.width = "";
                        panel.style.zIndex = "";
                    }
                }
            };
            return api;
        }

        let ddStation, ddServiced, ddMonth, ddDay, ddShift, ddAirlineLocal, ddAirlineForeign, ddAirlineDedicated;

        function closeAllDropdowns() {
            [
                ddStation, ddServiced, ddMonth, ddDay, ddShift,
                ddAirlineLocal, ddAirlineForeign, ddAirlineDedicated
            ].forEach(dd => dd && dd.close());
        }
        document.addEventListener("click", closeAllDropdowns);

        /*******************************************************
          LOAD FILE
        ********************************************************/
        document.getElementById("fileInput").addEventListener("change", async e => {
            const file = e.target.files[0];
            if (!file) return;

            let data;
            const ext = file.name.split(".").pop().toLowerCase();

            if (ext === "csv") {
                const text = await file.text();
                data = csvToJson(text);
            } else {
                const buf = await file.arrayBuffer();
                const wb = XLSX.read(buf, { type: "array" });
                const sheet = wb.Sheets[wb.SheetNames[0]];
                data = XLSX.utils.sheet_to_json(sheet, { defval: "" });
            }

            rows = data.map(normalizeRow).filter(Boolean);

            populateFilters(rows);
            document.getElementById("genBtn").disabled = false;
            generateTables();
        });

        function csvToJson(txt) {
            const lines = txt.split(/\r?\n/).filter(l => l.trim() !== "");
            const hdr = lines[0].split(",").map(h => h.trim());
            return lines.slice(1).map(l => {
                const p = l.split(",");
                const obj = {};
                hdr.forEach((h, i) => obj[h] = p[i] || "");
                return obj;
            });
        }

        function parseHour(t) {
            t = clean(t);
            if (!t.includes(":")) return null;
            const parts = t.split(" ");
            let h = Number(parts[0].split(":")[0]);
            if (Number.isNaN(h)) return null;
            const ampm = upper(parts[1] || "");
            if (ampm === "PM" && h !== 12) h += 12;
            if (ampm === "AM" && h === 12) h = 0;
            return (h >= 0 && h <= 23) ? h : null;
        }

        function normalizeRow(r) {
            const Station = upper(r["Station"]);
            const Location = upper(r["Location"]);
            const ServicedBy = upper(r["Serviced By"]);
            const Month = upper(r["Month"]);
            const AD = upper(r["A/D"]);
            const Airline = upper(r["AirLine"] || r["Airline"] || "");
            const Date = clean(r["Date"]);

            let hour = Number(r["Hour"]);
            if (Number.isNaN(hour)) hour = parseHour(r["Time"]);
            if (hour == null) return null;

            return { Date, Hour: hour, Station, Location, ServicedBy, Month, AD, Airline };
        }

        /*******************************************************
          FILTERS
        ********************************************************/
        function populateFilters(rows) {
            ddStation = createMultiDropdown("stationDD", "Select Station", generateTables);
            ddLocation = createMultiDropdown("locationDD", "Select Location", generateTables);
            ddServiced = createMultiDropdown("servicedDD", "Select Serviced By", generateTables);
            ddMonth = createMultiDropdown("monthDD", "Select Month", generateTables);
            ddDay = createMultiDropdown("dayDD", "Select Day", generateTables);
            ddShift = createMultiDropdown("shiftDD", "Select Shift", generateTables);
            ddAirlineLocal = createMultiDropdown("airlineLocalDD", "Local Airlines", generateTables);
            ddAirlineForeign = createMultiDropdown("airlineForeignDD", "Foreign Airlines", generateTables);
            ddAirlineDedicated = createMultiDropdown("airlineDedicatedDD", "Dedicated Teams", generateTables);

            ddStation.setItems(uniq(rows.map(r => r.Station)));
            ddLocation.setItems(uniq(rows.map(r => r.Location)));
            ddServiced.setItems(uniq(rows.map(r => r.ServicedBy)));
            
            // Sort months chronologically
            const monthsOrder = {
                "JAN": 1, "FEB": 2, "MAR": 3, "APR": 4, "MAY": 5, "JUN": 6,
                "JUL": 7, "AUG": 8, "SEP": 9, "OCT": 10, "NOV": 11, "DEC": 12,
                "JANUARY": 1, "FEBRUARY": 2, "MARCH": 3, "APRIL": 4, "MAY": 5, "JUNE": 6,
                "JULY": 7, "AUGUST": 8, "SEPTEMBER": 9, "OCTOBER": 10, "NOVEMBER": 11, "DECEMBER": 12
            };
            
            const uniqueMonths = [...new Set(rows.map(r => r.Month).filter(x => x))];
            uniqueMonths.sort((a, b) => {
                const ma = monthsOrder[a.toUpperCase()] || 99;
                const mb = monthsOrder[b.toUpperCase()] || 99;
                return ma - mb;
            });
            ddMonth.setItems(uniqueMonths);
            
            // Sort dates chronologically
            const uniqueDates = [...new Set(rows.map(r => r.Date).filter(x => x))];
            uniqueDates.sort((a, b) => {
                const da = new Date(a);
                const db = new Date(b);
                if (!isNaN(da.getTime()) && !isNaN(db.getTime())) {
                    return da - db;
                }
                return String(a).localeCompare(String(b));
            });
            ddDay.setItems(uniqueDates);

            ddShift.setItems(["Shift A", "Shift B", "Shift C"]);

            const ALL = uniq(rows.map(r => r.Airline));
            const LOCAL = ["SV", "F3", "XV", "RX"];
            const FOREIGN = ALL.filter(a => !LOCAL.includes(a));
            const DEDICATED = [...FOREIGN];
            ddAirlineLocal.setItems(LOCAL);
            ddAirlineForeign.setItems(FOREIGN);
            ddAirlineDedicated.setItems(DEDICATED);
        }

        function applyFilters(rows) {
            const ST = uniq([...ddStation.getSelected()].map(upper));
            const LO = uniq([...ddLocation.getSelected()].map(upper));
            const SV = uniq([...ddServiced.getSelected()].map(upper));
            const MO = uniq([...ddMonth.getSelected()].map(upper));
            const DA = uniq([...ddDay.getSelected()].map(clean));
            const SH = uniq([...ddShift.getSelected()]);
            const AI = uniq([
                ...ddAirlineLocal.getSelected(),
                ...ddAirlineForeign.getSelected(),
                ...ddAirlineDedicated.getSelected()
            ].map(upper));

            return rows.filter(r => {
                if (ST.length > 0 && !ST.includes(r.Station)) return false;
                if (LO.length > 0 && !LO.includes(r.Location)) return false;
                if (SV.length > 0 && !SV.includes(r.ServicedBy)) return false;
                if (MO.length > 0 && !MO.includes(r.Month)) return false;
                if (DA.length > 0 && !DA.includes(r.Date)) return false;
                if (SH.length > 0) {
                    const h = Number(r.Hour);
                    let matched = false;
                    if (SH.includes("Shift A") && isHourInShift(h, shiftDefinitions.A.start, shiftDefinitions.A.end)) matched = true;
                    if (!matched && SH.includes("Shift B") && isHourInShift(h, shiftDefinitions.B.start, shiftDefinitions.B.end)) matched = true;
                    if (!matched && SH.includes("Shift C") && isHourInShift(h, shiftDefinitions.C.start, shiftDefinitions.C.end)) matched = true;
                    
                    if (!matched) return false;
                }
                if (AI.length > 0 && !AI.includes(r.Airline)) return false;
                return true;
            });
        }

        /*******************************************************
          INTERVAL TABLES
        ********************************************************/
        function buildPivot(filtered) {
            const m = new Map();
            for (const r of filtered) {
                if (!m.has(r.Date)) m.set(r.Date, Array(24).fill(0));
                m.get(r.Date)[r.Hour] += 1;
            }
            return [...m.values()];
        }

        function colMax(matrix) {
            const out = Array(24).fill(0);
            for (const row of matrix) {
                for (let h = 0; h < 24; h++) {
                    if (row[h] > out[h]) out[h] = row[h];
                }
            }
            return out;
        }

        function rolling(row0, window, dir = "+") {
            const out = Array(24).fill(0);
            for (let h = 0; h < 24; h++) {
                let s = 0;
                for (let w = 0; w < window; w++) {
                    const idx = (dir === "+") ? (h + w) % 24 : (h - w + 24) % 24;
                    s += row0[idx];
                }
                out[h] = s;
            }
            return out;
        }

        function buildIntervalTable(filtered, dir = "+") {
            if (filtered.length === 0) return null;
            const pivot = buildPivot(filtered);
            const row0 = colMax(pivot);

            const rows = [];
            rows.push(["Hour", ...row0]);
            for (let w = 2; w <= 5; w++) {
                rows.push([`${w} hrs`, ...rolling(row0, w, dir)]);
            }

            return { header: HOURS, rows };
        }

        /*******************************************************
          MINI SUMMARY (5 columns only: Hour..5hrs)
          Ave/Max per ROW across 24 hours
        ********************************************************/
        function computeMini5(table) {
            if (!table) return null;

            // numericRows: 5 rows x 24 cols
            const numericRows = table.rows.map(r => r.slice(1));

            const avg5 = numericRows.map(row => {
                const s = row.reduce((a, b) => a + b, 0);
                return Math.round(s / row.length);
            });

            const max5 = numericRows.map(row => {
                return Math.max(...row);
            });

            return { avg5, max5 };
        }

        function computeShiftMax(table) {
            if (!table || !table.rows || table.rows.length === 0) return null;
            // Use the first data row (labeled "Hour") values across 24 hours
            const row0 = table.rows[0].slice(1);
            
            const shifts = ["A", "B", "C"];
            return shifts.map(key => {
                const def = shiftDefinitions[key];
                let maxVal = 0;
                // Since ranges can be non-contiguous (wrap midnight) or arbitrary,
                // we iterate all 24 hours and check membership.
                for (let h = 0; h < 24; h++) {
                    if (isHourInShift(h, def.start, def.end)) {
                        if (row0[h] > maxVal) maxVal = row0[h];
                    }
                }
                return maxVal;
            });
        }

        function renderMiniTable(containerId, table, includeShifts = false) {
            const el = document.getElementById(containerId);
            if (!table) { el.innerHTML = ""; return; }

            const mini = computeMini5(table);
            const shiftMax = includeShifts ? computeShiftMax(table) : null;
            const headers = ["Hour", "2 HRS", "3 HRS", "4 HRS", "5 HRS"];

            let html = `
    <table style="margin-top:16px;">
      <thead>
        <tr style="background: linear-gradient(145deg, #f3f4f6 0%, #e5e7eb 100%); color:#000000; font-weight:700; font-size:12px; text-transform:uppercase; letter-spacing:0.5px;">
          <th></th>
          ${headers.map(h => `<th>${h}</th>`).join("")}
        </tr>
      </thead>
      <tbody>
        <tr style="background: #ffffff;">
          <th style="background: linear-gradient(145deg, #f3f4f6 0%, #e5e7eb 100%); color:#000000; font-weight:700;">Average Flights</th>
          ${mini.avg5.map(v => `<td style="font-weight:600; color:#000000;">${v}</td>`).join("")}
        </tr>
        <tr style="background: #ffffff;">
          <th style="background: linear-gradient(145deg, #f3f4f6 0%, #e5e7eb 100%); color:#000000; font-weight:700;">Max Flights</th>
          ${mini.max5.map(v => `<td style="font-weight:600; color:#000000;">${v}</td>`).join("")}
        </tr>
      </tbody>
    </table>
  `;

            if (shiftMax) {
                const defA = shiftDefinitions.A;
                const defB = shiftDefinitions.B;
                const defC = shiftDefinitions.C;

                html += `
    <div style="margin-top:12px;">
      <table style="width:100%; border-collapse:separate; border-spacing:0; border:1px solid #334155; border-radius:12px; overflow:hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <thead>
          <tr style="background: linear-gradient(145deg, #1e293b 0%, #334155 100%); color:#ffffff; text-transform:uppercase; letter-spacing:0.5px; font-size:12px;">
            <th style="padding:10px; border-right:1px solid #334155;">Shift A (${defA.start}-${defA.end})</th>
            <th style="padding:10px; border-right:1px solid #334155;">Shift B (${defB.start}-${defB.end})</th>
            <th style="padding:10px;">Shift C (${defC.start}-${defC.end})</th>
          </tr>
        </thead>
        <tbody>
          <tr style="background: linear-gradient(145deg, #ede9fe 0%, #ddd6fe 100%); text-align:center; font-weight:700; color:#1e293b;">
            <td style="padding:12px; border-right:1px solid #d1c9ff;">${shiftMax[0]}</td>
            <td style="padding:12px; border-right:1px solid #d1c9ff;">${shiftMax[1]}</td>
            <td style="padding:12px;">${shiftMax[2]}</td>
          </tr>
        </tbody>
      </table>
    </div>
    `;
            }

            el.innerHTML = html;
        }

        /*******************************************************
          HEATMAP HTML RENDER
        ********************************************************/
        function pickColor(v, min, max) {
            if (max === min) return HEAT[0];
            const t = (v - min) / (max - min);
            if (t === 1) return HEAT[4];
            if (t > 0.75) return HEAT[3];
            if (t > 0.5) return HEAT[2];
            if (t > 0.25) return HEAT[1];
            return HEAT[0];
        }

        function renderTable(divId, table) {
            const el = document.getElementById(divId);
            if (!table) { el.innerHTML = `<div class="nodata">No Data</div>`; return; }

            let html = `<table><thead><tr style="background: linear-gradient(145deg, #f3f4f6 0%, #e5e7eb 100%); color:#000000; font-weight:700; font-size:12px; text-transform:uppercase; letter-spacing:0.5px;"><th>Intervals</th>`;
            for (const h of table.header) html += `<th>${h}:00</th>`;
            html += `</tr></thead><tbody>`;

            for (const r of table.rows) {
                const rowVals = r.slice(1);
                const rowMin = Math.min(...rowVals);
                const rowMax = Math.max(...rowVals);

                html += `<tr><th>${r[0]}</th>`;
                for (const v of rowVals) {
                    const bg = pickColor(v, rowMin, rowMax);
                    html += `<td style="background:${bg}; color:#000000; font-weight:600;">${v}</td>`;
                }
                html += `</tr>`;
            }
            html += `</tbody></table>`;
            el.innerHTML = html;
        }

        /*******************************************************
          GENERATE
        ********************************************************/
        function generateTables() {
            const base = applyFilters(rows);

            const arr = base.filter(r => r.AD === "A");
            const dep = base.filter(r => r.AD === "D");

            finalA = buildIntervalTable(arr, "+");
            finalD = buildIntervalTable(dep, "-");
            finalAll = buildIntervalTable(base, "+");

            renderTable("tblA", finalA);
            renderTable("tblD", finalD);
            renderTable("tblAll", finalAll);

            renderMiniTable("miniA", finalA);
            renderMiniTable("miniD", finalD);
            renderMiniTable("miniAll", finalAll, true);

            document.getElementById("downloadBtn").disabled = false;

            const sharedPayload = {
                generatedAt: new Date().toISOString(),
                filters: {
                    station: ddStation.getSelected(),
                    location: ddLocation.getSelected(),
                    servicedBy: ddServiced.getSelected(),
                    month: ddMonth.getSelected(),
                    localAirlines: ddAirlineLocal.getSelected(),
                    foreignAirlines: ddAirlineForeign.getSelected(),
                    dedicatedAirlines: ddAirlineDedicated.getSelected(),
                },
                flights: base,
                intervals: {
                    arrivals: finalA,
                    departures: finalD,
                    total: finalAll,
                }
            };
            safeStore("flightDataShared", sharedPayload);

            updateFunctionSupplies();
            setAllFunctionsBoxesVisible(true);
        }
        document.getElementById("genBtn").addEventListener("click", generateTables);

        /*******************************************************
          DOWNLOAD EXCEL (3 SHEETS + MINI TABLE 5 cols)
        ********************************************************/
        document.getElementById("downloadBtn").addEventListener("click", async () => {

            const wb = new ExcelJS.Workbook();

            const sheets = [
                { name: "Arrivals", title: "Flight Interval arrival", data: finalA },
                { name: "Departures", title: "Flight Interval departure", data: finalD },
                { name: "Total", title: "Flight Interval total", data: finalAll },
            ];

            for (const sh of sheets) {
                const ws = wb.addWorksheet(sh.name);
                const data = sh.data;

                if (!data) {
                    ws.addRow([sh.title]);
                    continue;
                }

                const lastCol = 1 + data.header.length; // 25

                // Title
                ws.mergeCells(1, 1, 1, lastCol);
                const t = ws.getCell(1, 1);
                t.value = sh.title;
                t.font = { bold: true, size: 14 };
                t.alignment = { vertical: "middle", horizontal: "center" };
                ws.getRow(1).height = 22;

                // Header (silver: hours light, Intervals darker)
                ws.addRow(["Intervals", ...data.header.map(h => `${h}:00`)]);
                const hdr = ws.getRow(2);

                for (let c = 2; c <= lastCol; c++) {
                    const cell = hdr.getCell(c);
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF3F4F6' } };
                    cell.font = { bold: true, color: { argb: 'FF000000' } };
                    cell.alignment = { vertical: "middle", horizontal: "center" };
                }
                const cellInt = hdr.getCell(1);
                cellInt.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD1D5DB' } };
                cellInt.font = { bold: true, color: { argb: 'FF000000' } };
                cellInt.alignment = { vertical: "middle", horizontal: "center" };

                // Data rows
                data.rows.forEach(r => ws.addRow(r));

                // Heat colors per row
                const C = ["FFd1fae5", "FF86efac", "FF4ade80", "FF22c55e", "FF15803d"];

                function excelColor(v, rowMin, rowMax) {
                    if (rowMax === rowMin) return C[0];
                    const t = (v - rowMin) / (rowMax - rowMin);
                    if (t === 1) return C[4];
                    if (t > 0.75) return C[3];
                    if (t > 0.5) return C[2];
                    if (t > 0.25) return C[1];
                    return C[0];
                }

                // Style first column labels (Intervals) silver
                for (let r = 3; r <= 2 + data.rows.length; r++) {
                    const cell = ws.getCell(r, 1);
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE5E7EB' } };
                    cell.font = { bold: true, color: { argb: 'FF000000' } };
                    cell.alignment = { vertical: "middle", horizontal: "center" };
                }

                // Style heatmap cells (per row)
                for (let rowIdx = 0; rowIdx < data.rows.length; rowIdx++) {
                    const r = 3 + rowIdx;
                    const rowVals = data.rows[rowIdx].slice(1);
                    const rowMin = Math.min(...rowVals);
                    const rowMax = Math.max(...rowVals);

                    for (let c = 2; c <= lastCol; c++) {
                        const cell = ws.getCell(r, c);
                        const v = Number(cell.value) || 0;
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: excelColor(v, rowMin, rowMax) } };
                        cell.font = { bold: true, color: { argb: 'FF000000' } };
                        cell.alignment = { vertical: "middle", horizontal: "center" };
                    }
                }

                // Border for main table
                const top = 2, left = 1, bottom = 2 + data.rows.length, right = lastCol;
                for (let r = top; r <= bottom; r++) {
                    for (let c = left; c <= right; c++) {
                        const cell = ws.getCell(r, c);
                        cell.border = {
                            top: { style: r === top ? 'medium' : 'thin', color: { argb: 'FF000000' } },
                            bottom: { style: r === bottom ? 'medium' : 'thin', color: { argb: 'FF000000' } },
                            left: { style: c === left ? 'medium' : 'thin', color: { argb: 'FF000000' } },
                            right: { style: c === right ? 'medium' : 'thin', color: { argb: 'FF000000' } },
                        };
                    }
                }

                // Column widths
                ws.getColumn(1).width = 12;
                for (let c = 2; c <= lastCol; c++) ws.getColumn(c).width = 6;

                // ===== MINI TABLE IN EXCEL (5 cols) =====
                const mini = computeMini5(data);
                const startMiniRow = bottom + 2; // blank row after main table

                ws.addRow([]); // blank

                // Mini header: 6 cols (label + 5) silver
                ws.addRow(["", "Hour", "2 HRS", "3 HRS", "4 HRS", "5 HRS"]);
                const miniHdrRow = ws.getRow(startMiniRow);

                for (let c = 1; c <= 6; c++) {
                    const cell = miniHdrRow.getCell(c);
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE5E7EB' } };
                    cell.font = { bold: true, color: { argb: 'FF000000' } };
                    cell.alignment = { vertical: "middle", horizontal: "center" };
                    cell.border = {
                        top: { style: "medium", color: { argb: "FF000000" } },
                        bottom: { style: "medium", color: { argb: "FF000000" } },
                        left: { style: "medium", color: { argb: "FF000000" } },
                        right: { style: "medium", color: { argb: "FF000000" } },
                    };
                }

                ws.addRow(["Ave Flights", ...mini.avg5]);
                ws.addRow(["Max Flights", ...mini.max5]);

                const aveRow = ws.getRow(startMiniRow + 1);
                const maxRow = ws.getRow(startMiniRow + 2);

                [aveRow, maxRow].forEach(rw => {
                    for (let c = 1; c <= 6; c++) {
                        const cell = rw.getCell(c);
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF3F4F6' } };
                        cell.font = { bold: true, color: { argb: 'FF000000' } };
                        cell.alignment = { vertical: "middle", horizontal: "center" };
                        cell.border = {
                            top: { style: "thin", color: { argb: "FF000000" } },
                            bottom: { style: "thin", color: { argb: "FF000000" } },
                            left: { style: "thin", color: { argb: "FF000000" } },
                            right: { style: "thin", color: { argb: "FF000000" } },
                        };
                    }
                });

                // Thick border around mini table
                const miniTop = startMiniRow, miniBottom = startMiniRow + 2, miniLeft = 1, miniRight = 6;
                for (let r = miniTop; r <= miniBottom; r++) {
                    for (let c = miniLeft; c <= miniRight; c++) {
                        const cell = ws.getCell(r, c);
                        cell.border = {
                            top: { style: r === miniTop ? 'medium' : 'thin', color: { argb: 'FF000000' } },
                            bottom: { style: r === miniBottom ? 'medium' : 'thin', color: { argb: 'FF000000' } },
                            left: { style: c === miniLeft ? 'medium' : 'thin', color: { argb: 'FF000000' } },
                            right: { style: c === miniRight ? 'medium' : 'thin', color: { argb: 'FF000000' } },
                        };
                    }
                }

                ws.getColumn(1).width = 16;
                for (let c = 2; c <= 6; c++) ws.getColumn(c).width = 10;
            }

            const buf = await wb.xlsx.writeBuffer();
            const blob = new Blob([buf], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "Flight_Intervals.xlsx";
            a.click();
            URL.revokeObjectURL(url);
        });

        function setAllFunctionsBoxesVisible(show) {
            document.querySelectorAll(".functions-grid").forEach(el => {
                el.style.display = show ? "" : "none";
            });
        }
        setAllFunctionsBoxesVisible(false);

        // DRAWER LOGIC
        const drawer = document.getElementById("filterDrawer");
        const overlay = document.getElementById("drawerOverlay");
        const openBtn = document.getElementById("openDrawerBtn");
        const closeBtn = document.getElementById("closeDrawerBtn");

        function openDrawer() {
            drawer.classList.add("open");
            overlay.classList.add("open");
        }
        function closeDrawer() {
            drawer.classList.remove("open");
            overlay.classList.remove("open");
        }

        if(openBtn) openBtn.addEventListener("click", openDrawer);
        if(closeBtn) closeBtn.addEventListener("click", closeDrawer);
        if(overlay) overlay.addEventListener("click", closeDrawer);

        // Shift Configuration Logic
        function initShiftConfig() {
            const getEl = (id) => document.getElementById(id);
            const sA_s = getEl("shiftA_start");
            const sA_e = getEl("shiftA_end");
            const sB_s = getEl("shiftB_start");
            const sB_e = getEl("shiftB_end");
            const sC_s = getEl("shiftC_start");
            const sC_e = getEl("shiftC_end");
            
            if(!sA_s) return; // safety

            // Populate inputs
            sA_s.value = shiftDefinitions.A.start;
            sA_e.value = shiftDefinitions.A.end;
            sB_s.value = shiftDefinitions.B.start;
            sB_e.value = shiftDefinitions.B.end;
            sC_s.value = shiftDefinitions.C.start;
            sC_e.value = shiftDefinitions.C.end;

            getEl("updateShiftsBtn").addEventListener("click", () => {
                const v = (el) => parseInt(el.value);
                const vals = [
                    v(sA_s), v(sA_e), v(sB_s), v(sB_e), v(sC_s), v(sC_e)
                ];

                // Basic validation (0-23)
                if (!vals.every(n => !isNaN(n) && n >= 0 && n <= 23)) {
                    alert("Please enter valid hours (0-23)");
                    return;
                }

                shiftDefinitions.A = { start: vals[0], end: vals[1] };
                shiftDefinitions.B = { start: vals[2], end: vals[3] };
                shiftDefinitions.C = { start: vals[4], end: vals[5] };

                safeStore("shiftDefinitions", shiftDefinitions);
                
                // Refresh if data loaded
                if (typeof generateTables === "function" && rows.length > 0) {
                    generateTables();
                }
                alert("Shift hours updated!");
            });
        }
        initShiftConfig();

        // TOGGLE LOGIC for Intervals
        document.getElementById("toggleIntervalsBtn").addEventListener("click", () => {
            const details = document.getElementById("intervalDetails");
            const btn = document.getElementById("toggleIntervalsBtn");
            if (details.style.display === "none") {
                details.style.display = "block";
                btn.textContent = "Hide Arrivals/Departures";
            } else {
                details.style.display = "none";
                btn.textContent = "Show Arrivals/Departures";
            }
        });

        // TOGGLE LOGIC for Shifts
        document.getElementById("toggleShiftsBtn").addEventListener("click", () => {
            const details = document.getElementById("shiftDetails");
            const btn = document.getElementById("toggleShiftsBtn");
            if (details.style.display === "none") {
                details.style.display = "block";
                btn.textContent = "Hide Shift Breakdown";
            } else {
                details.style.display = "none";
                btn.textContent = "Show Shift Breakdown";
            }
        });
        
        // Login Status Button Logic
        const role = localStorage.getItem('userRole');
        const loginBtn = document.getElementById('loginStatusBtn');
        if (loginBtn) {
            if (role === 'admin') {
                loginBtn.innerHTML = `
                    <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align: middle; margin-right: 8px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Logout (Admin)
                `;
                loginBtn.style.background = 'linear-gradient(145deg, #ef4444 0%, #dc2626 100%)';
                loginBtn.style.boxShadow = '0 4px 12px rgba(239, 68, 68, 0.4)';
                loginBtn.onclick = () => {
                    localStorage.removeItem('userRole');
                    window.location.reload();
                };
            } else {
                loginBtn.onclick = () => {
                    window.location.href = 'login.html';
                };
            }
        }
    </script>

</body>

</html>
