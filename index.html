<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Flight Interval Tables</title>

  <!-- SheetJS: read CSV/XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <!-- ExcelJS: write XLSX with styles -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>

  <style>
    body{
      margin:0; padding:24px;
      font-family: system-ui, -apple-system, Segoe UI, Arial;
      background:#0b1220; color:#e6eefc;
    }
    h2{margin:18px 0 8px; font-weight:800;}
    .card{
      background:#0f172a; border:1px solid #1f2a44;
      border-radius:14px; padding:16px; margin-top:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:end;}
    .row > *{flex:1; min-width:160px;}
    label{font-size:13px; opacity:.9; margin-bottom:6px; display:block;}
    select, input[type=file], button{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid #2a3a5d; background:#0b1220; color:#e6eefc;
      font-weight:600; outline:none;
    }
    button{
      cursor:pointer; background:#1e293b; border-color:#334155;
      transition:.15s;
    }
    button:hover{transform:translateY(-1px); background:#24324a;}

    /* Buttons layout */
    #genBtn{ width:100%; } /* full width */
    .download-wrap{
      display:flex; justify-content:center; margin-top:10px;
    }
    #downloadBtn{
      width:220px; background:#22c55e; border-color:#16a34a; color:#001b08;
      font-weight:800;
    }
    #downloadBtn:hover{ background:#2dd16a; }

    table{
      width:100%; border-collapse:separate; border-spacing:0;
      font-size:14px; overflow:hidden; border-radius:12px;
      border:1px solid #1f2a44; margin-top:10px;
    }
    thead th{
      background:#111a33; color:#eaf1ff;
      padding:8px; border-bottom:1px solid #1f2a44; font-weight:800;
    }
    tbody td, tbody th{
      padding:7px 8px; text-align:center;
      border-bottom:1px solid #14203c; border-right:1px solid #14203c;
      color:#0b1220; font-weight:700; background:#e8f5e9;
    }
    tbody tr:last-child td, tbody tr:last-child th{border-bottom:none;}
    tbody td:last-child, thead th:last-child{border-right:none;}
    tbody th{
      background:#0e1730; color:#eaf1ff; font-weight:800;
      text-align:left; padding-left:10px; position:sticky; left:0;
    }
    .nodata{padding:12px; opacity:.8; color:#ccc;}
  </style>
</head>

<body>

  <h2>Flight Interval Generator</h2>

  <div class="card">
    <div class="row">
      <div>
        <label>Upload CSV / Excel</label>
        <input id="fileInput" type="file" accept=".csv,.xlsx,.xls"/>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label>Station</label>
        <select id="stationFilter"></select>
      </div>
      <div>
        <label>Serviced By</label>
        <select id="servicedFilter"></select>
      </div>
      <div>
        <label>Month</label>
        <select id="monthFilter"></select>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <button id="genBtn" disabled>Generate Tables</button>
    </div>

    <div class="download-wrap">
      <button id="downloadBtn" disabled>Download Excel</button>
    </div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">Arrivals (A)</h2>
    <div id="tblA"></div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">Departures (D)</h2>
    <div id="tblD"></div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">All Flights (A + D)</h2>
    <div id="tblAll"></div>
  </div>


<script>
/********************************************
 GLOBALS
*********************************************/
let rows = [];
let finalA = null;
let finalD = null;
let finalAll = null;

const fileInput = document.getElementById("fileInput");
const genBtn = document.getElementById("genBtn");
const downloadBtn = document.getElementById("downloadBtn");

/********************************************
 UTIL
*********************************************/
const clean = x => (x ?? "").toString().trim();
const upper = x => clean(x).toUpperCase();
const HOURS = [...Array(24).keys()];

function uniq(arr){ return [...new Set(arr.filter(v=>v!==""))].sort(); }
function fillSelect(id,list){
  const el=document.getElementById(id);
  el.innerHTML = `<option value="ALL">All</option>` +
    list.map(v=>`<option value="${v}">${v}</option>`).join("");
}

/********************************************
 LOAD FILE
*********************************************/
fileInput.addEventListener("change", async e=>{
  const file = e.target.files[0];
  if(!file) return;

  const ext = file.name.split(".").pop().toLowerCase();
  let data;

  if(ext==="csv"){
    const text = await file.text();
    data = csvToJson(text);
  } else {
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, {type:"array"});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    data = XLSX.utils.sheet_to_json(sheet, {defval:""});
  }

  rows = data.map(normalizeRow).filter(Boolean);

  populateFilters(rows);
  genBtn.disabled = false;
});

function csvToJson(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim()!=="");
  const hdr = lines[0].split(",").map(h=>h.trim().replace(/\s+/g," "));
  const out=[];
  for(let i=1;i<lines.length;i++){
    const parts = lines[i].split(",");
    if(parts.length!==hdr.length) continue;
    const obj={};
    hdr.forEach((h,idx)=>obj[h]=parts[idx]||"");
    out.push(obj);
  }
  return out;
}

function parseHour(t){
  t = clean(t);
  if(!t.includes(":")) return null;
  const parts = t.split(" ");
  let h = Number(parts[0].split(":")[0]);
  if(Number.isNaN(h)) return null;
  const ampm = upper(parts[1]||"");
  if(ampm==="PM" && h!==12) h+=12;
  if(ampm==="AM" && h===12) h=0;
  return (h>=0 && h<=23) ? h : null;
}

function normalizeRow(r){
  const Station = upper(r["Station"]);
  const ServicedBy = upper(r["Serviced By"]);
  const Month = upper(r["Month"]);
  const AD = upper(r["A/D"]);
  const Date = clean(r["Date"]);

  let hour = Number(r["Hour"]);
  if(Number.isNaN(hour)) hour = parseHour(r["Time"]);
  if(hour==null) return null;

  return {Date, Hour:hour, Station, ServicedBy, Month, AD};
}

/********************************************
 FILTERS (NO A/D FILTER)
*********************************************/
function populateFilters(rows){
  fillSelect("stationFilter", uniq(rows.map(r=>r.Station)));
  fillSelect("servicedFilter", uniq(rows.map(r=>r.ServicedBy)));
  fillSelect("monthFilter", uniq(rows.map(r=>r.Month)));
}

function applyFiltersBase(all){
  const fST = upper(document.getElementById("stationFilter").value);
  const fSV = upper(document.getElementById("servicedFilter").value);
  const fMO = upper(document.getElementById("monthFilter").value);

  return all.filter(r=>{
    if(fST!=="ALL" && r.Station!==fST) return false;
    if(fSV!=="ALL" && r.ServicedBy!==fSV) return false;
    if(fMO!=="ALL" && r.Month!==fMO) return false;
    return true;
  });
}

/********************************************
 CORE LOGIC:
 Pivot(Date x Hour count)
 Row0 = max per hour across dates
 Row2..5 = rolling sums from Row0 only
*********************************************/
function buildPivotMatrix(filtered){
  const m = new Map();
  for(const r of filtered){
    if(!m.has(r.Date)) m.set(r.Date, Array(24).fill(0));
    m.get(r.Date)[r.Hour] += 1;
  }
  return Array.from(m.values());
}

function colMax(matrix){
  const out = Array(24).fill(0);
  for(const row of matrix){
    for(let h=0; h<24; h++){
      if(row[h] > out[h]) out[h]=row[h];
    }
  }
  return out;
}

function rollingFromRow0(row0, window, dir="+"){
  const res = Array(24).fill(0);
  for(let h=0; h<24; h++){
    let s=0;
    for(let w=0; w<window; w++){
      const idx = dir==="+" ? (h+w)%24 : (h-w+24)%24;
      s += row0[idx];
    }
    res[h]=s;
  }
  return res;
}

function buildIntervalTable(filtered, dir="+"){
  if(filtered.length===0) return null;
  const pivot = buildPivotMatrix(filtered);
  const row0 = colMax(pivot);

  const rowsOut = [];
  rowsOut.push(["Hour", ...row0]);
  for(let win=2; win<=5; win++){
    rowsOut.push([`${win} hrs`, ...rollingFromRow0(row0, win, dir)]);
  }

  return { header: HOURS, rows: rowsOut };
}

/********************************************
 HTML HEATMAP (5 FIXED COLORS)
*********************************************/
const HEAT_COLORS = ["#d1fae5","#86efac","#4ade80","#22c55e","#15803d"];

function pickHeatColor(v,min,max){
  if(max===min) return HEAT_COLORS[0];
  const t = (v-min)/(max-min);
  if(t===1) return HEAT_COLORS[4];
  if(t>0.75) return HEAT_COLORS[3];
  if(t>0.5) return HEAT_COLORS[2];
  if(t>0.25) return HEAT_COLORS[1];
  return HEAT_COLORS[0];
}

function renderTable(containerId, table){
  const el = document.getElementById(containerId);
  if(!table){
    el.innerHTML = `<div class="nodata">No Data</div>`;
    return;
  }

  const values = table.rows.flatMap(r=>r.slice(1));
  const minV = Math.min(...values);
  const maxV = Math.max(...values);

  let html = `<table><thead><tr><th>Intervals</th>`;
  for(const h of table.header) html += `<th>${h}:00</th>`;
  html += `</tr></thead><tbody>`;

  for(const r of table.rows){
    html += `<tr><th>${r[0]}</th>`;
    for(const v of r.slice(1)){
      const bg = pickHeatColor(v,minV,maxV);
      html += `<td style="background:${bg}; color:#000;">${v}</td>`;
    }
    html += `</tr>`;
  }

  html += `</tbody></table>`;
  el.innerHTML = html;
}

/********************************************
 GENERATE 3 TABLES
*********************************************/
genBtn.addEventListener("click", ()=>{
  const base = applyFiltersBase(rows);

  const arr = base.filter(r=>r.AD==="A");
  const dep = base.filter(r=>r.AD==="D");
  const all = base;

  finalA = buildIntervalTable(arr, "+");
  finalD = buildIntervalTable(dep, "-");
  finalAll = buildIntervalTable(all, "+");

  renderTable("tblA", finalA);
  renderTable("tblD", finalD);
  renderTable("tblAll", finalAll);

  downloadBtn.disabled = false;
});

/********************************************
 EXCEL DOWNLOAD WITH STYLES
 Req:
  - Header hours row fill #224A62
  - Intervals cell fill #7EAB55
  - First column labels blue w/ white text
  - Heatmap 5 fixed greens
  - Thick black border around table
  - 3 sheets
*********************************************/
downloadBtn.addEventListener("click", async ()=>{
  const wb = new ExcelJS.Workbook();

  const sheets = [
    { name:"Arrivals",  title:"Flight Interval arrival",   data:finalA },
    { name:"Departures",title:"Flight Interval departure", data:finalD },
    { name:"Total",     title:"Flight Interval total",     data:finalAll },
  ];

  for(const sh of sheets){
    const ws = wb.addWorksheet(sh.name);
    const data = sh.data;
    if(!data){
      ws.addRow([sh.title]);
      continue;
    }

    // ---- Title row A1:Y1 merged ----
    const lastCol = 1 + data.header.length; // A + 24 = 25 => Y
    ws.mergeCells(1,1,1,lastCol);
    const titleCell = ws.getCell(1,1);
    titleCell.value = sh.title;
    titleCell.alignment = {vertical:"middle", horizontal:"center"};
    titleCell.font = {bold:true, size:14};
    ws.getRow(1).height = 22;

    // ---- Header row (Intervals + hours) ----
    ws.addRow(["Intervals", ...data.header.map(h=>`${h}:00`)]);
    const headerRow = ws.getRow(2);
    headerRow.height = 18;

    // style header hours
    for(let c=2; c<=lastCol; c++){
      const cell = headerRow.getCell(c);
      cell.fill = {type:"pattern", pattern:"solid", fgColor:{argb:"FF224A62"}};
      cell.font = {bold:true, color:{argb:"FFFFFFFF"}};
      cell.alignment = {horizontal:"center", vertical:"middle"};
    }

    // style "Intervals" header cell
    const intervalsCell = headerRow.getCell(1);
    intervalsCell.fill = {type:"pattern", pattern:"solid", fgColor:{argb:"FF7EAB55"}};
    intervalsCell.font = {bold:true, color:{argb:"FF000000"}};
    intervalsCell.alignment = {horizontal:"center", vertical:"middle"};

    // ---- Data rows ----
    data.rows.forEach(r=>ws.addRow(r));

    // find min/max for heat buckets
    const nums = data.rows.flatMap(r=>r.slice(1));
    const minV = Math.min(...nums);
    const maxV = Math.max(...nums);
    const colorsARGB = ["FFd1fae5","FF86efac","FF4ade80","FF22c55e","FF15803d"];

    function pickExcelColor(v){
      if(maxV===minV) return colorsARGB[0];
      const t=(v-minV)/(maxV-minV);
      if(t===1) return colorsARGB[4];
      if(t>0.75) return colorsARGB[3];
      if(t>0.5) return colorsARGB[2];
      if(t>0.25) return colorsARGB[1];
      return colorsARGB[0];
    }

    // style first column labels (A3:A7)
    for(let r=3; r<=2+data.rows.length; r++){
      const cell = ws.getCell(r,1);
      cell.fill = {type:"pattern", pattern:"solid", fgColor:{argb:"FF224A62"}};
      cell.font = {bold:true, color:{argb:"FFFFFFFF"}};
      cell.alignment = {horizontal:"center", vertical:"middle"};
    }

    // style heatmap cells (B3:Y7)
    for(let r=3; r<=2+data.rows.length; r++){
      for(let c=2; c<=lastCol; c++){
        const cell = ws.getCell(r,c);
        const v = Number(cell.value)||0;
        const bg = pickExcelColor(v);
        cell.fill = {type:"pattern", pattern:"solid", fgColor:{argb:bg}};
        cell.font = {bold:true, color:{argb:"FF000000"}};
        cell.alignment = {horizontal:"center", vertical:"middle"};
      }
    }

    // borders: thin inside, thick outside
    const top = 2, left = 1;
    const bottom = 2 + data.rows.length;
    const right = lastCol;

    for(let r=top; r<=bottom; r++){
      for(let c=left; c<=right; c++){
        const cell = ws.getCell(r,c);
        const isTop = r===top, isBottom=r===bottom;
        const isLeft = c===left, isRight=c===right;

        cell.border = {
          top:    {style: isTop ? "medium" : "thin",  color:{argb:"FF000000"}},
          bottom: {style: isBottom?"medium":"thin",  color:{argb:"FF000000"}},
          left:   {style: isLeft?"medium":"thin",    color:{argb:"FF000000"}},
          right:  {style: isRight?"medium":"thin",   color:{argb:"FF000000"}},
        };
      }
    }

    // column widths
    ws.getColumn(1).width = 12;
    for(let c=2; c<=lastCol; c++) ws.getColumn(c).width = 6;
  }

  const buf = await wb.xlsx.writeBuffer();
  const blob = new Blob([buf],{
    type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
  });
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="Flight_Intervals.xlsx";
  a.click();
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>